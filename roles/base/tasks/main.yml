---
- name: install essential pkgs
  become: yes
  become_user: root
  with_items:
    - epel-release
  yum:
    name: '{{item}}'
    state: present

- name: install repo tool
  become: yes
  become_user: root
  with_items:
    - yum-plugin-fastestmirror
  yum:
    name: '{{item}}'
    state: latest

- name: Enable apply fastest mirror
  ini_file:
    path: /etc/yum/pluginconf.d/fastestmirror.conf
    section: main
    option: enabled
    value: 1
    backup: yes

- name: upgrade all packages
  yum:
    name: '*'
    state: latest

- name: install utils pkgs
  become: yes
  become_user: root
  with_items:
    - yum-updateonboot
    - yum-cron
    - yum-plugin-fastestmirror
    - ntp
    - bash
    - openssl
    - rsync
  yum:
    name: '{{item}}'
    state: latest

- name: Enable apply updated packages
  ini_file:
    path: /etc/yum/yum-cron.conf
    section: commands
    option: apply_updates
    value: yes
    backup: yes

- name: enable services
  become: yes
  become_user: root
  with_items:
    - yum-updateonboot
    - yum-cron
    - ntpd
  service:
    name: '{{item}}'
    enabled: yes

- name: generate ssh key
  become: yes
  become_user: root
  shell: rm -f ~/.ssh/id_rsa* && ssh-keygen -q -t rsa -N "" -f ~/.ssh/id_rsa

- name: load key pair
  become: yes
  become_user: root
  with_items:
    - id_rsa
    - id_rsa.pub
  copy:
    src: files/{{item}}
    dest: /root/.ssh/{{item}}
    owner: root
    group: root
    mode: 0600
    backup: yes

- name: add to authorized key
  become: yes
  become_user: root
  authorized_key:
    user: root
    state: present
    key: "{{ lookup('file', 'files/id_rsa.pub') }}"
