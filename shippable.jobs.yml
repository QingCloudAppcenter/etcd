jobs:
  - name: get_latest_etcd_release
    type: runSh
    steps:
      # This will automatically set the environment variables needed by rancher-compose
      - IN: pull_release_trigger
      - OUT: etcd_version
      - TASK:
        - script: |
            curl -s https://api.github.com/repos/coreos/etcd/releases/latest > result
            version=$(jq '.name' result| sed 's/"//g')
            url=$(jq '.url' result|sed 's/"//g')
            echo "Got etcd " $version " url " $url
            shipctl put_resource_state_multi etcd_version VERSIONNAME=$version URL=$url

  - name: download_etcd_package
    type: runSh
    steps:
      - IN: etcd_version
      - IN: qingstor_key
      - TASK:
        - script: |
            echo "download etcd" $VERSIONNAME
            echo "access_key_id: $access_key_id" > config.yaml
            echo "secret_access_key: $secret_access_key" >> config.yaml
            pip install -U qsctl
            mkdir etcd
            cd etcd
            wget $(curl -s $URL |grep 'browser_' | cut -d\" -f4)
            for file in `ls *|grep -v '.asc'`; do sha256sum $file | awk  '{ print "sha256:" $1 }' > $file.sha256; done
            qsctl cp -r --force . qs://github-releases/coreos/etcd/$VERSIONNAME/ -c ../config.yaml --zone pek3a

